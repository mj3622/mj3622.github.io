---
title: å®æˆ˜æŒ‡å—ï¼šä½¿ç”¨ Micrometer ä¸ Prometheus æ„å»º Java åº”ç”¨ç›‘æ§ä½“ç³»
published: 2026-02-01
description: æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•åœ¨ Java åº”ç”¨ä¸­é›†æˆ Micrometer å’Œ Prometheusï¼Œæ„å»ºé«˜æ•ˆçš„ç›‘æ§ä½“ç³»ã€‚é€šè¿‡å®æˆ˜ä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•é‡‡é›†å’Œæš´éœ²å…³é”®ä¸šåŠ¡æŒ‡æ ‡ï¼Œæå‡åº”ç”¨çš„å¯è§‚æµ‹æ€§ã€‚
tags: [Java, ç›‘æ§, Micrometer, Prometheus]
category: ç¼–ç¨‹å®è·µ
draft: false
---

# å¼•è¨€ï¼šå¯è§‚æµ‹æ€§ä¸ç°ä»£ Java åº”ç”¨

éšç€è½¯ä»¶æ¶æ„ä»å•ä½“åº”ç”¨å‘å¾®æœåŠ¡æ¶æ„å’Œäº‘åŸç”Ÿç¯å¢ƒæ¼”è¿›ï¼Œç³»ç»Ÿçš„å¤æ‚åº¦å’Œéƒ¨ç½²è§„æ¨¡å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸçŸ­æš‚ä¸”åŠ¨æ€ï¼Œä¼ ç»Ÿçš„â€œå‡ºç°é—®é¢˜æŸ¥æ—¥å¿—â€çš„æ’æŸ¥æ–¹å¼å·²éš¾ä»¥åº”å¯¹æœåŠ¡é—´å¤æ‚çš„è°ƒç”¨é“¾è·¯å’Œèµ„æºç«äº‰é—®é¢˜ã€‚

åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹ï¼Œåº”ç”¨çš„å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰ä¸å†æ˜¯å¯é€‰é¡¹ï¼Œè€Œæ˜¯ç»´æŒç³»ç»Ÿç¨³å®šæ€§çš„åˆšéœ€ã€‚å¯è§‚æµ‹æ€§é€šå¸¸ç”±ä¸‰å¤§æ”¯æŸ±ç»„æˆï¼š**Loggingï¼ˆæ—¥å¿—ï¼‰**ã€**Tracingï¼ˆé“¾è·¯è¿½è¸ªï¼‰** å’Œ **Metricsï¼ˆæŒ‡æ ‡ç›‘æ§ï¼‰**ã€‚å…¶ä¸­ï¼ŒMetrics ä¾§é‡äºèšåˆæ•°æ®çš„ç»Ÿè®¡ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå‘ç°â€œç³»ç»Ÿå“åº”å˜æ…¢äº†â€ã€â€œé”™è¯¯ç‡å‡é«˜äº†â€æˆ–â€œå†…å­˜æ³„æ¼äº†â€ç­‰å®è§‚è¶‹åŠ¿ï¼Œæ˜¯æ•…éšœå‘ç°çš„ç¬¬ä¸€é“é˜²çº¿ã€‚

åœ¨ Java ç”Ÿæ€ä¸­ï¼Œæ„å»ºè¿™é“é˜²çº¿æœ€ç»å…¸ä¸”å¼ºå¤§çš„ç»„åˆè«è¿‡äº **Micrometer** ä¸ **Prometheus**ã€‚

## 1. å·¥å…·å®šä½ï¼šè§£è€¦ä¸å­˜å‚¨

è¦ç†è§£è¿™ä¸¤è€…çš„é…åˆå…³ç³»ï¼Œé¦–å…ˆéœ€è¦æ˜ç¡®å®ƒä»¬å„è‡ªåœ¨ç›‘æ§ä½“ç³»ä¸­çš„è§’è‰²ï¼š

**Micrometerï¼šMetrics ç•Œçš„ SLF4J**

æ­£å¦‚ SLF4J ç»Ÿä¸€äº† Log4jã€Logback ç­‰æ—¥å¿—æ¡†æ¶çš„æ¥å£ä¸€æ ·ï¼ŒMicrometer æ—¨åœ¨ä¸º Java å¹³å°ä¸Šçš„ç›‘æ§æŒ‡æ ‡é‡‡é›†æä¾›ä¸€ä¸ªç»Ÿä¸€çš„é—¨é¢ï¼ˆFacadeï¼‰ã€‚

å®ƒæä¾›äº†ä¸€å¥—ä¸å…·ä½“ç›‘æ§åç«¯è§£è€¦çš„æ ‡å‡†åŒ–æ¥å£ï¼ˆå¦‚ `Counter`ã€`Timer`ã€`Gauge`ï¼‰ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œä½ åªéœ€è¦é’ˆå¯¹ Micrometer çš„ API è¿›è¡ŒåŸ‹ç‚¹ç¼–ç¨‹ï¼Œè€Œæ— éœ€å…³å¿ƒåº•å±‚çš„ç›‘æ§ç³»ç»Ÿæ˜¯ Prometheusã€Datadogã€InfluxDB è¿˜æ˜¯ Elasticã€‚è¿™ç§è®¾è®¡ä½¿å¾—åº”ç”¨èƒ½å¤Ÿä»¥é›¶ä»£ç ä¿®æ”¹çš„æˆæœ¬ï¼Œåœ¨ä¸åŒçš„ç›‘æ§ç³»ç»Ÿä¹‹é—´æ— ç¼åˆ‡æ¢ã€‚

**Prometheusï¼šäº‘åŸç”Ÿæ—¶ä»£çš„ç›‘æ§æ ‡å‡†**

Prometheus æ˜¯ä¸€ä¸ªå¼€æºçš„ç³»ç»Ÿç›‘æ§å’ŒæŠ¥è­¦å·¥å…·åŒ…ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**æ—¶åºæ•°æ®åº“ï¼ˆTSDBï¼‰**ã€‚ä¸ä¼ ç»Ÿç›‘æ§ç³»ç»Ÿçš„ä¸»åŠ¨æ¨é€ï¼ˆPushï¼‰æ¨¡å¼ä¸åŒï¼ŒPrometheus é‡‡ç”¨**æ‹‰å–ï¼ˆPullï¼‰**æ¨¡å¼ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬çš„ Java åº”ç”¨åªéœ€è¦æš´éœ²ä¸€ä¸ª HTTP ç«¯ç‚¹ï¼ˆEndpointï¼‰ï¼ŒPrometheus æœåŠ¡ç«¯ä¼šæŒ‰ç…§é…ç½®çš„æ—¶é—´é—´éš”ï¼Œå®šæœŸæ¥â€œæŠ“å–â€å½“å‰çš„æŒ‡æ ‡æ•°æ®ã€‚

Prometheus ä»¥å…¶å¼ºå¤§çš„ PromQL æŸ¥è¯¢è¯­è¨€ã€é«˜æ•ˆçš„æ•°æ®å­˜å‚¨ä»¥åŠä¸ Kubernetes çš„åŸç”Ÿäº²å’Œæ€§ï¼Œå·²æˆä¸ºäº‘åŸç”Ÿæ—¶ä»£ç›‘æ§äº‹å®ä¸Šçš„æ ‡å‡†ã€‚

## 2. æœ¬æ–‡ç›®æ ‡

æœ¬æ–‡å°†é€šè¿‡å®æˆ˜ä»£ç ï¼Œæ¼”ç¤ºå¦‚ä½•åœ¨ **Spring Boot 3.x** é¡¹ç›®ä¸­é›†æˆ Micrometerï¼Œå®Œæˆä»¥ä¸‹ç›®æ ‡ï¼š

1. **åŸºç¡€æ¥å…¥**ï¼šå¼•å…¥ä¾èµ–å¹¶å¼€å¯ Actuator ç«¯ç‚¹ï¼Œå°† JVM æ ‡å‡†æŒ‡æ ‡æš´éœ²ç»™ Prometheusã€‚
2. **ä¸šåŠ¡åŸ‹ç‚¹**ï¼šä½¿ç”¨ Micrometer çš„æ ¸å¿ƒ API å®ç°è‡ªå®šä¹‰ä¸šåŠ¡ç›‘æ§ï¼ˆå¦‚ API è¯·æ±‚è®¡æ•°ã€å…³é”®é€»è¾‘è€—æ—¶ç»Ÿè®¡ï¼‰ã€‚
3. **æ•°æ®éªŒè¯**ï¼šç¡®ä¿ Prometheus èƒ½å¤Ÿæ­£ç¡®é‡‡é›†æ•°æ®ï¼Œå¹¶éªŒè¯æ•°æ®æ ¼å¼çš„æ­£ç¡®æ€§ã€‚

é€šè¿‡æŒæ¡è¿™å¥—ç»„åˆæ‹³ï¼Œä½ å°†èƒ½å¤Ÿä¸ºåº”ç”¨æ„å»ºèµ·ä¸€å¥—å¯è§†åŒ–ã€å¯é‡åŒ–çš„å¥åº·ç›‘æµ‹ä½“ç³»ã€‚

# æ ¸å¿ƒæ¦‚å¿µè§£æ

åœ¨ä½¿ç”¨ Micrometer è¿›è¡ŒåŸ‹ç‚¹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥ç†è§£å…¶æ ¸å¿ƒæŠ½è±¡ã€‚Micrometer çš„è®¾è®¡å“²å­¦ä¸ SLF4J ç±»ä¼¼ï¼Œå®ƒä¸ç›´æ¥äº§ç”Ÿæ•°æ®ï¼Œè€Œæ˜¯å®šä¹‰äº†ä¸€å¥—æ ‡å‡†åŒ–çš„ API æ¥â€œè®°å½•â€æ•°æ®ã€‚

## 1. Meter Registryï¼ˆæŒ‡æ ‡æ³¨å†Œè¡¨ï¼‰

`MeterRegistry` æ˜¯ Micrometer çš„å…¥å£å’Œæ ¸å¿ƒå®¹å™¨ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆåº”ç”¨ä¸­çš„â€œè®°è´¦æœ¬â€æˆ–â€œä»ªè¡¨ç›˜æ§åˆ¶å™¨â€ã€‚

- **åŠŸèƒ½**ï¼šå®ƒè´Ÿè´£åˆ›å»ºã€ç»´æŠ¤æ‰€æœ‰çš„ç›‘æ§æŒ‡æ ‡ï¼ˆMetersï¼‰ï¼Œå¹¶å°†è¿™äº›æŒ‡æ ‡æ ¼å¼åŒ–ä¸ºåº•å±‚ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ Prometheusï¼‰èƒ½å¤Ÿè¯†åˆ«çš„æ•°æ®æ ¼å¼ã€‚
- **åœ¨ Spring Boot ä¸­**ï¼šSpring Boot Actuator ä¼šè‡ªåŠ¨é…ç½®ä¸€ä¸ª `PrometheusMeterRegistry` å¹¶æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨ä¸šåŠ¡ä»£ç ä¸­é€šè¿‡ä¾èµ–æ³¨å…¥è·å– `MeterRegistry` å®ä¾‹ï¼Œå³å¯å¼€å§‹åŸ‹ç‚¹ã€‚

```java
// Spring è‡ªåŠ¨æ³¨å…¥ç¤ºä¾‹
@Service
public class OrderService {
    private final MeterRegistry registry;

    public OrderService(MeterRegistry registry) {
        this.registry = registry;
    }
}

```

## 2. Meter ç±»å‹è¯¦è§£

Micrometer æä¾›äº†å¤šç§ç±»å‹çš„ Meterï¼ˆæŒ‡æ ‡ï¼‰æ¥åº”å¯¹ä¸åŒçš„ç›‘æ§åœºæ™¯ã€‚é€‰æ‹©æ­£ç¡®çš„ Meter ç±»å‹æ˜¯è·å–å‡†ç¡®æ•°æ®çš„å…³é”®ã€‚

### 2.1 Counterï¼ˆè®¡æ•°å™¨ï¼‰

- **å®šä¹‰**ï¼šä¸€ç§**åªå¢ä¸å‡**çš„è®¡æ•°å™¨ã€‚
- **è¡Œä¸º**ï¼šå®ƒä» 0 å¼€å§‹ï¼Œæ¯æ¬¡äº‹ä»¶å‘ç”Ÿæ—¶è°ƒç”¨ `increment()`ã€‚å®ƒç±»ä¼¼äºæ±½è½¦çš„**é‡Œç¨‹è¡¨**ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
  - API è¯·æ±‚æ€»é‡ï¼ˆ`http_requests_total`ï¼‰
  - ä»»åŠ¡å®Œæˆæ€»æ•°
  - å¼‚å¸¸/é”™è¯¯å‘ç”Ÿçš„æ€»æ¬¡æ•°

- **Prometheus ç‰¹æ€§**ï¼šPrometheus ä¼šå­˜å‚¨ Counter çš„ç´¯åŠ å€¼ã€‚åœ¨æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PromQL çš„ `rate()` æˆ– `increase()` å‡½æ•°æ¥è®¡ç®—å…¶**å¢é•¿é€Ÿç‡**ï¼ˆä¾‹å¦‚ï¼šæ¯ç§’è¯·æ±‚æ•° QPSï¼‰ã€‚

### 2.2 Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰

- **å®šä¹‰**ï¼šåæ˜ åº”ç”¨ç¨‹åºå½“å‰**ç¬æ—¶çŠ¶æ€**çš„æ•°å€¼ã€‚
- **è¡Œä¸º**ï¼šæ•°å€¼å¯ä»¥è‡ªç”±å‡é«˜æˆ–é™ä½ã€‚å®ƒç±»ä¼¼äºæ±½è½¦çš„**é€Ÿåº¦è¡¨**æˆ–**è½¬é€Ÿè¡¨**ã€‚
- **å…³é”®åŒºåˆ«**ï¼šä¸ Counter ä¸åŒï¼Œä½ é€šå¸¸ä¸æ˜¯æ‰‹åŠ¨â€œè®¾ç½®â€ Gauge çš„å€¼ï¼Œè€Œæ˜¯å‘Šè¯‰ Micrometer å»â€œè§‚å¯Ÿâ€æŸä¸ªå¯¹è±¡çš„å±æ€§ã€‚Micrometer ä¼šåœ¨ Prometheus æŠ“å–æ•°æ®æ—¶ï¼Œå®æ—¶è¯»å–è¯¥å±æ€§çš„å€¼ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
  - å½“å‰ CPU ä½¿ç”¨ç‡
  - å†…å­˜ä½¿ç”¨é‡
  - çº¿ç¨‹æ± ä¸­æ´»è·ƒçº¿ç¨‹æ•°
  - é˜Ÿåˆ—ï¼ˆQueueï¼‰ä¸­çš„å¾…å¤„ç†æ¶ˆæ¯å †ç§¯é‡

### 2.3 Timerï¼ˆè®¡æ—¶å™¨ï¼‰

- **å®šä¹‰**ï¼šç”¨äºæµ‹é‡çŸ­æ—¶é—´äº‹ä»¶çš„**è€—æ—¶**ä»¥åŠ**å‘ç”Ÿé¢‘ç‡**ã€‚
- **è¡Œä¸º**ï¼šTimer æ˜¯æœ€å¤æ‚çš„æŒ‡æ ‡ç±»å‹ä¹‹ä¸€ã€‚å½“ä½ è®°å½•ä¸€ä¸ªäº‹ä»¶çš„è€—æ—¶æ—¶ï¼ŒMicrometer å®é™…ä¸Šåœ¨åå°ä¸ºä½ è®°å½•äº†è‡³å°‘ä¸¤ä¸ªå€¼ï¼š

    1. **Count**ï¼šäº‹ä»¶å‘ç”Ÿçš„æ€»æ¬¡æ•°ï¼ˆç±»ä¼¼äº Counterï¼‰ã€‚
    2. **Sum**ï¼šäº‹ä»¶æ¶ˆè€—çš„æ€»æ—¶é—´ã€‚
    3. **Max**ï¼šè¯¥æ—¶é—´çª—å£å†…çš„æœ€å¤§è€—æ—¶ï¼ˆå¯é€‰ï¼‰ã€‚

- **é«˜çº§ç‰¹æ€§**ï¼šTimer æ”¯æŒå®¢æˆ·ç«¯è®¡ç®—ç™¾åˆ†ä½æ•°ï¼ˆPercentilesï¼Œå¦‚ P99, P95ï¼‰æˆ–ç›´æ–¹å›¾ï¼ˆHistogramï¼‰ï¼Œè¿™å¯¹äºåˆ†æâ€œé•¿å°¾å»¶è¿Ÿâ€è‡³å…³é‡è¦ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
  - HTTP æ¥å£å“åº”æ—¶é—´
  - æ•°æ®åº“ SQL æŸ¥è¯¢è€—æ—¶
  - å…³é”®ä¸šåŠ¡é€»è¾‘çš„å¤„ç†æ—¶é•¿

### 2.4 DistributionSummaryï¼ˆåˆ†å¸ƒæ‘˜è¦ï¼‰

- **å®šä¹‰**ï¼šç”¨äºè·Ÿè¸ª**éæ—¶é—´**æ•°æ®çš„åˆ†å¸ƒæƒ…å†µã€‚
- **è¡Œä¸º**ï¼šå®ƒçš„æœºåˆ¶ä¸ Timer å‡ ä¹ä¸€è‡´ï¼ˆè®°å½• Count, Sum, Maxï¼‰ï¼Œä½†è®°å½•çš„å•ä½ä¸æ˜¯â€œæ—¶é—´â€ï¼Œè€Œæ˜¯â€œå¤§å°â€æˆ–â€œæ•°é‡â€ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
  - HTTP å“åº”ä½“çš„å¤§å°ï¼ˆResponse Size in Bytesï¼‰
  - æ‰¹å¤„ç†ä»»åŠ¡ä¸­æ¯æ¬¡å¤„ç†çš„è®°å½•æ•°
  - I/O æ“ä½œçš„ååé‡

## 3. Tagsï¼ˆæ ‡ç­¾ï¼‰ï¼šå¤šç»´ç›‘æ§çš„çµé­‚

åœ¨ä¼ ç»Ÿçš„ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ Graphiteï¼‰ä¸­ï¼Œæˆ‘ä»¬ä¹ æƒ¯ä½¿ç”¨å±‚çº§å‘½åæ³•ï¼Œä¾‹å¦‚ `server.us-east.db.error`ã€‚è¿™ç§æ–¹å¼åœ¨é¢å¯¹äº‘åŸç”Ÿç¯å¢ƒæ—¶æ˜¾å¾—åŠ›ä¸ä»å¿ƒâ€”â€”å¦‚æœæˆ‘ä»¬æƒ³æŸ¥è¯¢â€œæ‰€æœ‰åœ°åŒºâ€çš„ DB é”™è¯¯ï¼Œå°±éœ€è¦æå…¶å¤æ‚çš„é€šé…ç¬¦åŒ¹é…ã€‚

Micrometer å¼•å…¥äº† **Tagsï¼ˆæ ‡ç­¾/ç»´åº¦ï¼‰** çš„æ¦‚å¿µï¼Œè¿™æ˜¯ç°ä»£ç›‘æ§ç³»ç»Ÿçš„åŸºçŸ³ã€‚

- **å®šä¹‰**ï¼šTag æ˜¯ä¸€ä¸ª Key-Value å¯¹ï¼Œç”¨äºä¸ºæŒ‡æ ‡æ·»åŠ é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
- **ç¤ºä¾‹**ï¼š
  ä¸è¦åˆ›å»ºä¸€ä¸ªåä¸º `http_requests_error_500` çš„æŒ‡æ ‡ã€‚
  **åº”è¯¥**åˆ›å»ºä¸€ä¸ªåä¸º `http_requests_total` çš„æŒ‡æ ‡ï¼Œå¹¶èµ‹äºˆå…¶æ ‡ç­¾ `status=500`, `method=POST`, `uri=/api/users`ã€‚
- **ä¼˜åŠ¿**ï¼š

    1. **èšåˆèƒ½åŠ›**ï¼šä½ å¯ä»¥è½»æ¾æŸ¥è¯¢ `http_requests_total` è·å¾—æ€»æµé‡ï¼Œæˆ–è€…æŒ‰ `status` åˆ†ç»„æŸ¥è¯¢é”™è¯¯åˆ†å¸ƒã€‚
    2. **åŸºæ•°çˆ†ç‚¸ï¼ˆCardinality Explosionï¼‰è­¦å‘Š**ï¼š**åˆ‡è®°**ä¸è¦å°†å–å€¼æ— é™çš„å˜é‡ä½œä¸º Tag å€¼ï¼ˆä¾‹å¦‚ `userId`, `orderId`, `timestamp`ï¼‰ã€‚è¿™ä¼šå¯¼è‡´ Prometheus å†…å­˜æº¢å‡ºï¼Œå› ä¸ºæ¯ä¸€ç»„å”¯ä¸€çš„ Tag ç»„åˆéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ—¶é—´åºåˆ—ã€‚

> **æœ€ä½³å®è·µ**ï¼šå§‹ç»ˆæ€è€ƒâ€œæˆ‘æ˜¯å¦éœ€è¦æŒ‰è¿™ä¸ªç»´åº¦è¿›è¡Œèšåˆï¼ˆGroup Byï¼‰ï¼Ÿâ€å¦‚æœç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œä¸”è¯¥ç»´åº¦çš„å–å€¼æ˜¯æœ‰é™çš„ï¼ˆå¦‚é”™è¯¯ç ã€åœ°åŒºã€å®ä¾‹ IDï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªå¥½çš„ Tagã€‚

# ç¯å¢ƒå‡†å¤‡ä¸ä¾èµ–é›†æˆ

åœ¨å¼€å§‹ç¼–å†™ç›‘æ§ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ­å»ºå¥½åŸºç¡€çš„è¿è¡Œç¯å¢ƒã€‚Spring Boot å¯¹ Micrometer çš„æ”¯æŒéå¸¸å®Œå–„ï¼Œé€šè¿‡ç®€å•çš„ä¾èµ–å¼•å…¥å’Œé…ç½®ï¼Œå³å¯å®ç°â€œé›¶ä»£ç â€çš„åŸºç¡€æŒ‡æ ‡æš´éœ²ã€‚

## 1. æŠ€æœ¯æ ˆè¯´æ˜

ä¸ºäº†ä¿è¯å®æˆ˜å†…å®¹çš„æ™®é€‚æ€§ä¸æ—¶æ•ˆæ€§ï¼Œæœ¬æ•™ç¨‹åŸºäºä»¥ä¸‹ä¸»æµç‰ˆæœ¬è¿›è¡Œæ¼”ç¤ºï¼š

- **Java**: JDK 17+ (Spring Boot 3.x çš„æœ€ä½è¦æ±‚)
- **Framework**: Spring Boot 3.x
- **Monitoring System**: Prometheus 2.x

## 2. Maven ä¾èµ–å¼•å…¥

åœ¨ä½ çš„ `pom.xml` ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœä½ çš„é¡¹ç›®ç»§æ‰¿è‡ª `spring-boot-starter-parent`ï¼Œé€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å·ã€‚

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>

    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-registry-prometheus</artifactId>
    </dependency>
    
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>

```

**ä¾èµ–è§£æï¼š**

- **`spring-boot-starter-actuator`**ï¼šè¿™æ˜¯ Spring Boot æä¾›çš„ç”Ÿäº§çº§ç‰¹æ€§æ¨¡å—ï¼Œå®ƒè‡ªåŠ¨é…ç½®äº†å¤§é‡çš„å†…ç½®æŒ‡æ ‡ï¼ˆå¦‚ JVM å†…å­˜ã€GCã€çº¿ç¨‹æ± ã€HTTP è¯·æ±‚ç»Ÿè®¡ç­‰ï¼‰ï¼Œå¹¶æä¾›äº† HTTP ç«¯ç‚¹æ¥æš´éœ²è¿™äº›ä¿¡æ¯ã€‚
- **`micrometer-registry-prometheus`**ï¼šActuator æœ¬èº«æ”¶é›†çš„æ•°æ®æ˜¯é€šç”¨çš„ï¼Œè€Œè¿™ä¸ªåº“å……å½“äº†â€œç¿»è¯‘å®˜â€çš„è§’è‰²ã€‚å®ƒä¼šåœ¨ Actuator ä¸­æ·»åŠ ä¸€ä¸ª `/prometheus` ç«¯ç‚¹ï¼Œå¹¶å°†æ‰€æœ‰æŒ‡æ ‡æ ¼å¼åŒ–ä¸º Prometheus è¦æ±‚çš„æ–‡æœ¬æ ¼å¼ã€‚

## 3. é…ç½®æ–‡ä»¶è®¾ç½® (application.yml)

å¼•å…¥ä¾èµ–åï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡é…ç½®æ–‡ä»¶ï¼ˆ`application.yml`ï¼‰æ¥å¯ç”¨ Prometheus ç«¯ç‚¹ï¼Œå¹¶æ·»åŠ ä¸€äº›å…¨å±€æ ‡è¯†ã€‚

```yaml
spring:
  application:
    name: order-service  # 1. å®šä¹‰åº”ç”¨åç§°ï¼Œåç»­ä¼šä½œä¸ºæ ¸å¿ƒ Tag

management:
  endpoints:
    web:
      exposure:
        include: 'prometheus,health,info' # 2. æ˜¾å¼æš´éœ² prometheus ç«¯ç‚¹
  
  endpoint:
    prometheus:
      enabled: true # ç¡®ä¿æ’ä»¶å¼€å¯ï¼ˆé»˜è®¤é€šå¸¸ä¸º trueï¼‰

  metrics:
    tags:
      application: ${spring.application.name} # 3. é…ç½®å…¬å…± Tag

```

**å…³é”®é…ç½®è¯¦è§£ï¼š**

1. **ç«¯ç‚¹æš´éœ² (`management.endpoints.web.exposure.include`)**ï¼š
    - å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒSpring Boot é»˜è®¤åªæš´éœ² `/health` å’Œ `/info` ç«¯ç‚¹ã€‚
    - æˆ‘ä»¬éœ€è¦æ˜¾å¼æ·»åŠ  `prometheus`ï¼Œè¿™æ ·å¤–éƒ¨ç³»ç»Ÿæ‰èƒ½é€šè¿‡ HTTP è®¿é—®åˆ°ç›‘æ§æ•°æ®ã€‚

2. **å…¬å…±æ ‡ç­¾ (`management.metrics.tags.application`)**ï¼š

- **è¿™æ˜¯å¾®æœåŠ¡ç›‘æ§ä¸­æœ€é‡è¦çš„ä¸€æ­¥é…ç½®ã€‚**
  - å½“ä½ æœ‰å‡ åä¸ªå¾®æœåŠ¡ï¼ˆOrder, User, Paymentï¼‰åŒæ—¶å‘ Prometheus å‘é€æ•°æ®æ—¶ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªæ ‡ç­¾ï¼Œä½ å°†æ— æ³•åŒºåˆ†â€œCPU ä½¿ç”¨ç‡ 90%â€çš„æ•°æ®åˆ°åº•æ¥è‡ªå“ªä¸ªæœåŠ¡ã€‚
  - é…ç½®åï¼Œæ‰€æœ‰ä»è¯¥åº”ç”¨å‘å‡ºçš„æŒ‡æ ‡éƒ½ä¼šè‡ªåŠ¨å¸¦ä¸Š `application=order-service` çš„æ ‡ç­¾ï¼Œæ–¹ä¾¿åç»­åœ¨ Grafana ä¸­è¿›è¡Œè¿‡æ»¤å’Œèšåˆã€‚

## 4. éªŒè¯å®‰è£…

é…ç½®å®Œæˆåï¼Œå¯åŠ¨ Spring Boot åº”ç”¨ï¼Œå¹¶åœ¨æµè§ˆå™¨æˆ–é€šè¿‡ `curl` è®¿é—®ä»¥ä¸‹åœ°å€ï¼š

`http://localhost:8080/actuator/prometheus`

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°å¤§é‡å¦‚ä¸‹æ ¼å¼çš„çº¯æ–‡æœ¬æ•°æ®ï¼š

```text
# HELP jvm_memory_used_bytes The amount of used memory
# TYPE jvm_memory_used_bytes gauge
jvm_memory_used_bytes{application="order-service",area="heap",id="G1 Survivor Space",} 1572864.0
jvm_memory_used_bytes{application="order-service",area="heap",id="G1 Old Gen",} 3407872.0
...

```

çœ‹åˆ°è¿™äº›æ•°æ®ï¼Œè¯´æ˜ä½ çš„ Java åº”ç”¨å·²ç»åšå¥½äº†è¢« Prometheus æŠ“å–çš„å‡†å¤‡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥ä»£ç ï¼Œæ·»åŠ æ›´è´´åˆä¸šåŠ¡éœ€æ±‚çš„è‡ªå®šä¹‰æŒ‡æ ‡ã€‚

# å®æˆ˜ï¼šè‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡åŸ‹ç‚¹

åœ¨å®Œæˆäº†åŸºç¡€çš„ JVM å’Œç³»ç»ŸæŒ‡æ ‡æ¥å…¥åï¼Œç›‘æ§ä½“ç³»çš„çœŸæ­£ä»·å€¼åœ¨äº**ä¸šåŠ¡æŒ‡æ ‡**ã€‚æˆ‘ä»¬éœ€è¦çŸ¥é“â€œæœ‰å¤šå°‘è®¢å•ä¸‹å•å¤±è´¥äº†â€ã€â€œæ ¸å¿ƒç®—æ³•æ‰§è¡ŒèŠ±äº†å¤šé•¿æ—¶é—´â€ä»¥åŠâ€œå½“å‰å¾…å¤„ç†çš„æ¶ˆæ¯ç§¯å‹äº†å¤šå°‘â€ã€‚

æœ¬èŠ‚å°†é€šè¿‡ä¸‰ä¸ªç»å…¸åœºæ™¯ï¼Œæ¼”ç¤ºå¦‚ä½•åœ¨ Service å±‚æˆ– Controller å±‚æ³¨å…¥ `MeterRegistry` å¹¶å®ç°è‡ªå®šä¹‰åŸ‹ç‚¹ã€‚

## åœºæ™¯ä¸€ï¼šç»Ÿè®¡ API è®¿é—®æ¬¡æ•° (Counter)

è¿™æ˜¯æœ€åŸºç¡€çš„ç›‘æ§éœ€æ±‚ã€‚è™½ç„¶ Actuator é»˜è®¤æä¾›äº† HTTP è¯·æ±‚çš„ç»Ÿè®¡ï¼Œä½†åœ¨æŸäº›ä¸šåŠ¡é€»è¾‘åˆ†æ”¯ï¼ˆå¦‚â€œæ”¯ä»˜å¤±è´¥â€æˆ–â€œåº“å­˜ä¸è¶³â€ï¼‰ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ›´ç»†ç²’åº¦çš„è®¡æ•°ã€‚

**ç›®æ ‡**ï¼šç»Ÿè®¡è®¢å•åˆ›å»ºæ¥å£çš„è°ƒç”¨æ¬¡æ•°ï¼Œå¹¶åŒºåˆ†â€œæˆåŠŸâ€ä¸â€œå¤±è´¥â€ã€‚

```java
import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.stereotype.Service;

@Service
public class OrderService {

    private final MeterRegistry registry;

    // 1. æ„é€ å™¨æ³¨å…¥ MeterRegistry
    public OrderService(MeterRegistry registry) {
        this.registry = registry;
    }

    public void createOrder(Order order) {
        try {
            // ... æ‰§è¡Œæ ¸å¿ƒä¸‹å•é€»è¾‘ ...
            
            // 2. åŸ‹ç‚¹ï¼šè®°å½•æˆåŠŸ
            // ä½¿ç”¨ builder æ¨¡å¼æ„å»ºï¼Œæ–¹ä¾¿æ·»åŠ  Tag
            Counter.builder("business.order.created")
                    .tag("status", "success")
                    .description("Total number of successful orders")
                    .register(registry)
                    .increment(); 
                    
        } catch (Exception e) {
            // 3. åŸ‹ç‚¹ï¼šè®°å½•å¤±è´¥
            Counter.builder("business.order.created")
                    .tag("status", "failure")
                    .tag("reason", e.getClass().getSimpleName()) // æ³¨æ„ï¼šç¡®ä¿ exception ç±»åæ•°é‡æœ‰é™
                    .description("Total number of failed orders")
                    .register(registry)
                    .increment();
            throw e;
        }
    }
}

```

> **ğŸ’¡ æœ€ä½³å®è·µ**ï¼šä¸è¦åˆ›å»ºä¸¤ä¸ªåä¸º `order_success_total` å’Œ `order_failure_total` çš„æŒ‡æ ‡ã€‚åº”è¯¥åˆ›å»ºä¸€ä¸ªåä¸º `business_order_created` çš„æŒ‡æ ‡ï¼Œåˆ©ç”¨ Tag (`status=success/failure`) æ¥åŒºåˆ†ã€‚è¿™æ ·åœ¨ Grafana ä¸­æ—¢å¯ä»¥çœ‹æ€»æ•°ï¼Œä¹Ÿå¯ä»¥çœ‹æˆåŠŸç‡ã€‚

## åœºæ™¯äºŒï¼šç›‘æ§å…³é”®ä¸šåŠ¡æ–¹æ³•è€—æ—¶ (Timer)

å¯¹äºæ ¸å¿ƒä¸šåŠ¡é“¾è·¯ï¼ˆå¦‚ç»“ç®—ã€æ¨èç®—æ³•è®¡ç®—ï¼‰ï¼Œä»…çŸ¥é“å¹³å‡è€—æ—¶æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨é•¿å°¾å»¶è¿Ÿï¼ˆå¦‚ P99ï¼Œå³ 99% çš„è¯·æ±‚éƒ½åœ¨å¤šå°‘æ¯«ç§’å†…å®Œæˆï¼‰ã€‚

**ç›®æ ‡**ï¼šç›‘æ§ `calculatePrice` æ–¹æ³•çš„æ‰§è¡Œè€—æ—¶åŠåˆ†å¸ƒã€‚

### æ–¹å¼ Aï¼šç¼–ç¨‹å¼åŸ‹ç‚¹ï¼ˆæœ€çµæ´»ï¼‰

```java
import io.micrometer.core.instrument.Timer;

public void calculatePrice() {
    // 1. æ„å»º Timer
    Timer timer = Timer.builder("business.price.calculation")
            .publishPercentiles(0.5, 0.95, 0.99) // é‡ç‚¹ï¼šå¼€å¯ P50, P95, P99 ç›´æ–¹å›¾ç»Ÿè®¡
            .publishPercentileHistogram()        // å¼€å¯ Prometheus ç›´æ–¹å›¾ buckets
            .register(registry);

    // 2. åŒ…è£…ä¸šåŠ¡é€»è¾‘
    timer.record(() -> {
        // è¿™é‡Œæ”¾ç½®åŸæœ¬çš„å¤æ‚è®¡ç®—é€»è¾‘
        simulateSlowTask();
    });
}

```

### æ–¹å¼ Bï¼šæ³¨è§£å¼åŸ‹ç‚¹ï¼ˆæœ€ç®€æ´ï¼‰

å¦‚æœä½ ä¸æƒ³ä¾µå…¥ä¸šåŠ¡ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ Spring çš„ AOP åˆ‡é¢ã€‚

é¦–å…ˆåœ¨é…ç½®ç±»ä¸­æ³¨å†Œ `TimedAspect` Beanï¼š

```java
@Bean
public TimedAspect timedAspect(MeterRegistry registry) {
    return new TimedAspect(registry);
}

```

ç„¶ååœ¨æ–¹æ³•ä¸Šæ·»åŠ  `@Timed` æ³¨è§£ï¼š

```java
@Timed(value = "business.price.calculation", histogram = true, percentiles = {0.95, 0.99})
public void calculatePrice() {
    // ä¸šåŠ¡é€»è¾‘...
}

```

## åœºæ™¯ä¸‰ï¼šç›‘æ§å®æ—¶åº“å­˜æˆ–é˜Ÿåˆ—æ·±åº¦ (Gauge)

`Gauge` çš„é€»è¾‘ä¸å‰ä¸¤è€…å®Œå…¨ä¸åŒã€‚ä½ ä¸éœ€è¦åœ¨æ•°æ®å˜åŒ–æ—¶å»â€œé€šçŸ¥â€ Micrometerï¼Œè€Œæ˜¯è¦å®šä¹‰â€œå¦‚ä½•è·å–æ•°æ®â€ã€‚Micrometer ä¼šåœ¨ Prometheus æ¥æŠ“å–æ•°æ®çš„é‚£ä¸€åˆ»ï¼Œå»è°ƒç”¨ä½ æä¾›çš„å‡½æ•°ã€‚

**ç›®æ ‡**ï¼šç›‘æ§å†…éƒ¨ä»»åŠ¡é˜Ÿåˆ—çš„å½“å‰ç§¯å‹æ•°é‡ã€‚

```java
import io.micrometer.core.instrument.Gauge;
import org.springframework.stereotype.Component;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;

@Component
public class TaskManager {

    // å‡è®¾è¿™æ˜¯ä¸€ä¸ªæ‰¿è½½å¾…å¤„ç†ä»»åŠ¡çš„é˜Ÿåˆ—
    private final BlockingQueue<Runnable> taskQueue = new LinkedBlockingQueue<>();
    
    public TaskManager(MeterRegistry registry) {
        // 1. ç»‘å®š Gauge
        // å…³é”®ç‚¹ï¼šç›´æ¥ä¼ å…¥è¢«ç›‘æ§çš„å¯¹è±¡ (taskQueue) å’Œ è·å–æ•°å€¼çš„å‡½æ•° (Queue::size)
        Gauge.builder("business.task.queue.size", taskQueue, BlockingQueue::size)
             .description("Current number of tasks waiting in queue")
             .register(registry);
             
        // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦è°ƒç”¨ .increment() æˆ– .set()
        // Micrometer ä¼šæŒæœ‰ taskQueue çš„å¼±å¼•ç”¨ï¼Œå®šæœŸè½®è¯¢ size() æ–¹æ³•
    }

    public void submitTask(Runnable task) {
        taskQueue.offer(task);
    }
}

```

**âš ï¸ é¿å‘æŒ‡å—**ï¼š

- ä¸è¦å¯¹ `Gauge` ä½¿ç”¨ `increment()` æ“ä½œã€‚å¦‚æœä½ å‘ç°è‡ªå·±åœ¨æ‰‹åŠ¨åŠ å‡ä¸€ä¸ªæ•°å­—æ¥ç»´æŠ¤çŠ¶æ€ï¼Œè¯·æ£€æŸ¥æ˜¯å¦åº”è¯¥ä½¿ç”¨ `Counter`ï¼ˆå¦‚æœæ˜¯ç´¯åŠ ï¼‰æˆ–è€…ä»…ä»…æ˜¯è®© `Gauge` è§‚å¯Ÿä¸€ä¸ªå·²å­˜åœ¨çš„å˜é‡ã€‚
- ç¡®ä¿æä¾›ç»™ `Gauge` çš„è·å–æ•°å€¼å‡½æ•°ï¼ˆSupplierï¼‰æ˜¯**éé˜»å¡ä¸”é«˜æ•ˆ**çš„ã€‚å› ä¸ºæ¯æ¬¡ Prometheus æŠ“å–éƒ½ä¼šè§¦å‘è¯¥å‡½æ•°ï¼Œå¦‚æœ `size()` è®¡ç®—å¾ˆæ…¢ï¼ˆä¾‹å¦‚ `Select count(*) from big_table`ï¼‰ï¼Œä¼šæ‹–æ…¢æ•´ä¸ªåº”ç”¨ã€‚

# Prometheus æœåŠ¡ç«¯é…ç½®ä¸é‡‡é›†

åº”ç”¨ç«¯çš„å‡†å¤‡å·¥ä½œå·²ç»å°±ç»ªï¼Œç°åœ¨çš„ Java åº”ç”¨å°±åƒä¸€ä¸ªä¸çŸ¥ç–²å€¦çš„å¹¿æ’­å°ï¼Œåœ¨ `/actuator/prometheus` é¢‘é“ä¸ŠæŒç»­æ’­æŠ¥ç€å†…éƒ¨çŠ¶æ€ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦é…ç½® Prometheus æœåŠ¡ç«¯ï¼ˆæ”¶éŸ³æœºï¼‰æ¥æŒ‰æ—¶æ”¶å¬å¹¶è®°å½•è¿™äº›ä¿¡æ¯ã€‚

## 1. æ¶æ„æ ¸å¿ƒï¼šPull æ¨¡å¼çš„å·¥ä½œåŸç†

ç†è§£ Prometheus çš„æ ¸å¿ƒåœ¨äºç†è§£å®ƒçš„ **Pullï¼ˆæ‹‰å–ï¼‰æ¨¡å¼**ã€‚

ä¸ä¼ ç»Ÿçš„ Pushï¼ˆæ¨é€ï¼‰æ¨¡å¼ï¼ˆåº”ç”¨ä¸»åŠ¨å‘æ•°æ®ç»™ç›‘æ§ä¸­å¿ƒï¼‰ä¸åŒï¼ŒPrometheus æ›´åŠ ä¸»åŠ¨ï¼š

1. **Retrievalï¼ˆæ£€ç´¢ï¼‰**ï¼šPrometheus Server æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„åˆ—è¡¨ï¼Œå®šæœŸï¼ˆå¦‚æ¯ 15 ç§’ï¼‰å»è¿æ¥åº”ç”¨æš´éœ²çš„ HTTP ç«¯ç‚¹ã€‚
2. **Storageï¼ˆå­˜å‚¨ï¼‰**ï¼šè·å–åˆ°æ–‡æœ¬æ ¼å¼çš„æŒ‡æ ‡åï¼Œæ‰“ä¸Šæ—¶é—´æˆ³ï¼Œå­˜å‚¨åˆ°æœ¬åœ°çš„æ—¶é—´åºåˆ—æ•°æ®åº“ä¸­ã€‚
3. **Discoveryï¼ˆå‘ç°ï¼‰**ï¼šåœ¨åŠ¨æ€ç¯å¢ƒä¸­ï¼ˆå¦‚ Kubernetesï¼‰ï¼ŒPrometheus è¿˜å¯ä»¥é€šè¿‡æœåŠ¡å‘ç°æœºåˆ¶è‡ªåŠ¨æ‰¾åˆ°æ–°çš„æœåŠ¡å®ä¾‹ï¼Œè€Œæ— éœ€æ‰‹åŠ¨é…ç½®é™æ€ IPã€‚

è¿™ç§æ¨¡å¼çš„ä¼˜ç‚¹åœ¨äºï¼š**åº”ç”¨ä¸ç›‘æ§ç³»ç»Ÿå®Œå…¨è§£è€¦**ã€‚å¦‚æœ Prometheus æŒ‚äº†ï¼Œä½ çš„ä¸šåŠ¡æœåŠ¡ä¸ä¼šå—åˆ°ä»»ä½•å½±å“ï¼ˆä¸ä¼šå› ä¸ºå‘é€ç›‘æ§æ•°æ®å¤±è´¥è€Œé˜»å¡ï¼‰ã€‚

## 2. é…ç½® prometheus.yml

æ‰¾åˆ° Prometheus çš„ä¸»é…ç½®æ–‡ä»¶ `prometheus.yml`ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `scrape_configs` èŠ‚ç‚¹ä¸‹å¢åŠ ä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼ˆJobï¼‰ã€‚

è¯·é‡ç‚¹å…³æ³¨ `metrics_path` çš„é…ç½®ï¼Œè¿™æ˜¯ Spring Boot ä¸æ ‡å‡† Prometheus é»˜è®¤è¡Œä¸ºä¸åŒçš„åœ°æ–¹ã€‚

```yaml
global:
  scrape_interval: 15s # å…¨å±€æŠ“å–é¢‘ç‡ï¼Œé»˜è®¤15ç§’

scrape_configs:
  # ... å…¶ä»– job é…ç½® ...

  # æ–°å¢ Spring Boot åº”ç”¨çš„æŠ“å–ä»»åŠ¡
  - job_name: 'spring-boot-order-service'
    
    # ã€å…³é”®ã€‘Spring Boot Actuator æš´éœ²çš„é»˜è®¤è·¯å¾„æ˜¯ /actuator/prometheus
    # è€Œ Prometheus é»˜è®¤æ‰¾çš„æ˜¯ /metricsï¼Œæ‰€ä»¥å¿…é¡»æ˜¾å¼è¦†ç›–
    metrics_path: '/actuator/prometheus'
    
    # è®¾ç½®æŠ“å–è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢åº”ç”¨å“åº”æ…¢å¯¼è‡´æ•°æ®ä¸¢å¤±
    scrape_timeout: 10s
    
    static_configs:
      # è¿™é‡Œå¡«å†™ä½  Java åº”ç”¨çš„ IP å’Œç«¯å£
      # å¦‚æœ Prometheus è¿è¡Œåœ¨ Docker ä¸­ï¼Œå®¿ä¸»æœº IP é€šå¸¸ä¸æ˜¯ localhost
      - targets: ['192.168.1.100:8080'] 
        labels:
          env: 'prod' # å¯ä»¥é™„åŠ é¢å¤–çš„æ ‡ç­¾ï¼Œæ–¹ä¾¿åç»­ç­›é€‰

```

**é…ç½®é¡¹è§£æï¼š**

- **`job_name`**ï¼šé€»è¾‘åˆ†ç»„åç§°ã€‚æ‰€æœ‰ä»è¿™é‡ŒæŠ“å–åˆ°çš„æ•°æ®éƒ½ä¼šè‡ªåŠ¨å¸¦ä¸Š `job="spring-boot-order-service"` çš„æ ‡ç­¾ã€‚
- **`metrics_path`**ï¼š**å¿…å¡«**ã€‚Micrometer é»˜è®¤é€‚é…çš„è·¯å¾„ã€‚å¦‚æœä¸æ”¹ï¼ŒPrometheus ä¼šæŠ¥ 404 é”™è¯¯ã€‚
- **`targets`**ï¼šç›®æ ‡å®ä¾‹åˆ—è¡¨ã€‚ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸é…åˆ Consul æˆ– K8s è¿›è¡ŒåŠ¨æ€æœåŠ¡å‘ç°ï¼Œä½†åœ¨æµ‹è¯•æˆ–ç®€å•éƒ¨ç½²ä¸­ï¼Œ`static_configs` è¶³çŸ£ã€‚

## 3. éªŒè¯é‡‡é›†

é…ç½®ä¿®æ”¹å¹¶é‡å¯ Prometheus æœåŠ¡åï¼Œæˆ‘ä»¬éœ€è¦éªŒè¯æ•°æ®é“¾è·¯æ˜¯å¦æ‰“é€šã€‚

### ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ Target çŠ¶æ€

æ‰“å¼€ Prometheus çš„ Web UIï¼ˆé»˜è®¤ç«¯å£ 9090ï¼‰ï¼Œå¯¼èˆªè‡³èœå•æ çš„ **Status -> Targets**ã€‚

- **State ä¸º UP (ç»¿è‰²)**ï¼šæ­å–œï¼é…ç½®æˆåŠŸï¼ŒPrometheus å·²ç»æˆåŠŸè¿æ¥åˆ°ä½ çš„ Java åº”ç”¨å¹¶æŠ“å–åˆ°äº†æ•°æ®ã€‚
- **State ä¸º DOWN (çº¢è‰²)**ï¼šæ£€æŸ¥ Error åˆ—çš„ä¿¡æ¯ã€‚å¸¸è§åŸå› åŒ…æ‹¬ç½‘ç»œä¸é€šã€`metrics_path` å¡«é”™ï¼ˆ404ï¼‰ã€æˆ–è€…åº”ç”¨æœªå¯åŠ¨ã€‚

### ç¬¬äºŒæ­¥ï¼šæŸ¥è¯¢ UP æŒ‡æ ‡

ç‚¹å‡»å¯¼èˆªæ çš„ **Graph**ï¼Œåœ¨æŸ¥è¯¢æ¡†ä¸­è¾“å…¥ï¼š

```promql
up{job="spring-boot-order-service"}

```

ç‚¹å‡» "Execute"ã€‚

- å¦‚æœè¿”å›å€¼ä¸º **1**ï¼šä»£è¡¨æœåŠ¡å¥åº·åœ¨çº¿ã€‚
- å¦‚æœè¿”å›å€¼ä¸º **0**ï¼šä»£è¡¨æœåŠ¡æ— æ³•è¿æ¥ã€‚

è¿™ä¸ªç®€å•çš„ `up` æŒ‡æ ‡æ˜¯ç›‘æ§ä¸­æœ€åŸºç¡€çš„â€œå¿ƒè·³â€ï¼Œé€šå¸¸ä¹Ÿæ˜¯æˆ‘ä»¬å°†è¦é…ç½®çš„ç¬¬ä¸€æ¡å‘Šè­¦è§„åˆ™ï¼ˆå¦‚æœ `up == 0` æŒç»­ 1 åˆ†é’Ÿï¼Œåˆ™å‘é€ P0 çº§å‘Šè­¦ï¼‰ã€‚

# æ•°æ®å¯è§†åŒ–ï¼šGrafana é›†æˆ

å¦‚æœè¯´ Prometheus æ˜¯ç›‘æ§æ•°æ®çš„â€œä»“åº“â€ï¼Œé‚£ä¹ˆ Grafana å°±æ˜¯è£…ä¿®ç²¾ç¾çš„â€œé™ˆåˆ—å®¤â€ã€‚è™½ç„¶ Prometheus è‡ªå¸¦ Web UIï¼Œä½†å®ƒæ›´é€‚åˆç”¨äºè°ƒè¯•å’Œä¸´æ—¶æŸ¥è¯¢ã€‚è¦å®ç°ç‚«é…·çš„ã€å¯èšåˆå¤šæ•°æ®æºçš„å®æ—¶å¤§å±ï¼ŒGrafana æ‰æ˜¯æœ€ä½³æ‹æ¡£ã€‚

## 1. æ•°æ®æºé…ç½®

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰ Grafana å»å“ªé‡Œè¯»å–æ•°æ®ã€‚

1. ç™»å½• Grafanaï¼ˆé»˜è®¤ç«¯å£ 3000ï¼‰ã€‚
2. ç‚¹å‡»å·¦ä¾§é½¿è½®å›¾æ ‡ **Configuration** -> **Data Sources**ã€‚
3. ç‚¹å‡» **Add data source**ï¼Œé€‰æ‹© **Prometheus**ã€‚
4. åœ¨ **HTTP -> URL** æ ä¸­å¡«å…¥ Prometheus çš„åœ°å€ï¼ˆä¾‹å¦‚ `http://localhost:9090` æˆ– Docker å®¹å™¨åï¼‰ã€‚
5. ç‚¹å‡»åº•éƒ¨çš„ **Save & Test**ã€‚å¦‚æœä¸å‡ºç°ç»¿è‰²çš„ "Data source is working" æç¤ºï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ã€‚

## 2. Dashboards æ¨èï¼šç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š

Grafana æ‹¥æœ‰åºå¤§çš„ç¤¾åŒºç”Ÿæ€ï¼Œå¯¹äºæ ‡å‡†çš„ Java åº”ç”¨ç›‘æ§ï¼Œæˆ‘ä»¬å®Œå…¨ä¸éœ€è¦ä»é›¶å¼€å§‹ç»˜å›¾ã€‚

### å¼•å…¥å®˜æ–¹ JVM é¢æ¿ (ID: 4701)

Micrometer å®˜æ–¹æä¾›äº†ä¸€ä¸ªéå¸¸ç»å…¸ä¸”å…¨é¢çš„ Dashboardï¼Œèƒ½è¦†ç›– 90% çš„åŸºç¡€ç›‘æ§éœ€æ±‚ã€‚

- **å¯¼å…¥æ­¥éª¤**ï¼šç‚¹å‡»å·¦ä¾§ **Dashboards** (å››æ–¹å—å›¾æ ‡) -> **Import**ã€‚
- **è¾“å…¥ ID**ï¼šåœ¨ "Import via grafana.com" è¾“å…¥æ¡†ä¸­å¡«å…¥ **4701**ï¼Œç‚¹å‡» Loadã€‚
- **é€‰æ‹©æ•°æ®æº**ï¼šåœ¨åº•éƒ¨ä¸‹æ‹‰æ¡†é€‰æ‹©åˆšæ‰é…ç½®çš„ Prometheus æ•°æ®æºï¼Œç‚¹å‡» **Import**ã€‚

å¯¼å…¥æˆåŠŸåï¼Œä½ å°†ç«‹å³çœ‹åˆ°ä¸€ä¸ªåŒ…å«ä»¥ä¸‹æ ¸å¿ƒæŒ‡æ ‡çš„ç›‘æ§å¤§å±ï¼š

- **JVM å†…å­˜**ï¼šHeap/Non-Heap ä½¿ç”¨è¯¦æƒ…ï¼Œç›´è§‚å‘ç°å†…å­˜æ³„æ¼é£é™©ã€‚
- **GC åˆ†æ**ï¼šGC æ¬¡æ•°ã€GC æš‚åœæ—¶é—´ï¼ˆStop The Worldï¼‰ï¼Œè¿™æ˜¯æ’æŸ¥å¡é¡¿é—®é¢˜çš„ç¥å™¨ã€‚
- **çº¿ç¨‹ç›‘æ§**ï¼šå½“å‰æ´»è·ƒçº¿ç¨‹æ•°ã€Daemon çº¿ç¨‹æ•°ã€‚
- **CPU ä½¿ç”¨ç‡**ï¼šJVM è¿›ç¨‹å ç”¨çš„ç³»ç»Ÿèµ„æºã€‚

### åˆ›å»ºè‡ªå®šä¹‰ä¸šåŠ¡é¢æ¿

è§£å†³äº†åŸºç¡€è®¾æ–½ç›‘æ§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å±•ç¤ºå‰æ–‡ä¸­åŸ‹ç‚¹çš„ä¸šåŠ¡æŒ‡æ ‡ã€‚

1. æ–°å»ºä¸€ä¸ª Dashboardï¼Œç‚¹å‡» **Add a new panel**ã€‚
2. åœ¨ **Metrics browser** ä¸­è¾“å…¥ PromQL æŸ¥è¯¢è¯­å¥ã€‚
3. **å®æˆ˜æ¡ˆä¾‹**ï¼š

- **ä¸‹å•é‡è¶‹åŠ¿å›¾**ï¼šé€‰æ‹© Time Series å›¾è¡¨ï¼ŒæŸ¥è¯¢ `increase(business_order_created_total[1m])`ï¼Œå±•ç¤ºæ¯åˆ†é’Ÿæ–°å¢çš„è®¢å•æ•°ã€‚

- **æ¥å£è€—æ—¶çƒ­åŠ›å›¾**ï¼šåˆ©ç”¨ Timer æŒ‡æ ‡ï¼Œå±•ç¤ºæ¥å£å“åº”æ—¶é—´çš„åˆ†å¸ƒã€‚

## 3. PromQL åŸºç¡€ï¼šæŸ¥è¯¢çš„è‰ºæœ¯

è¦åœ¨ Grafana ä¸­ç”»å‡ºæœ‰æ„ä¹‰çš„å›¾è¡¨ï¼ŒæŒæ¡åŸºç¡€çš„ PromQL (Prometheus Query Language) æ˜¯å¿…ä¿®è¯¾ã€‚ä»¥ä¸‹æ˜¯ä¸‰ä¸ªæœ€å¸¸ç”¨çš„æ ¸å¿ƒå‡½æ•°ï¼š

### 3.1 `rate()` â€”â€” è®¡ç®—é€Ÿç‡ (QPS)

**é€‚ç”¨åœºæ™¯**ï¼šCounter ç±»å‹æŒ‡æ ‡ï¼ˆå¦‚è¯·æ±‚æ€»æ•°ï¼‰ã€‚
ç”±äº Counter æ˜¯åªå¢ä¸å‡çš„ï¼Œç›´æ¥ç”»å›¾æ˜¯ä¸€æ¡æ–œå‘ä¸Šçš„ç›´çº¿ï¼Œæ²¡æœ‰æ„ä¹‰ã€‚æˆ‘ä»¬éœ€è¦çœ‹çš„æ˜¯â€œæ¯ç§’å¢é•¿äº†å¤šå°‘â€ã€‚

```promql
# è®¡ç®—è¿‡å» 5 åˆ†é’Ÿå†…ï¼Œæ¯ç§’çš„å¹³å‡è¯·æ±‚æ•°
rate(http_server_requests_seconds_count[5m])

```

*æ³¨æ„ï¼š`irate()` ä¹Ÿå¯ä»¥è®¡ç®—é€Ÿç‡ï¼Œå®ƒå¯¹ç¬æ—¶å˜åŒ–æ›´æ•æ„Ÿï¼Œé€‚åˆæŸ¥çœ‹å°–å³°ï¼›`rate()` æ›´åŠ å¹³æ»‘ï¼Œé€‚åˆåšå‘Šè­¦å’Œè¶‹åŠ¿åˆ†æã€‚*

### 3.2 `increase()` â€”â€” è®¡ç®—å¢é‡

**é€‚ç”¨åœºæ™¯**ï¼šä¸šåŠ¡ç»Ÿè®¡ï¼ˆå¦‚è¿‡å»ä¸€å°æ—¶å–äº†å¤šå°‘å•ï¼‰ã€‚
å®ƒè®¡ç®—çš„æ˜¯æ—¶é—´åŒºé—´å†…æ•°å€¼çš„**å¢é•¿é‡**ã€‚

```promql
# ç»Ÿè®¡è¿‡å» 1 å°æ—¶å†…æ–°å¢çš„è®¢å•æ€»æ•°
increase(business_order_created_total[1h])

```

### 3.3 Histogram ç™¾åˆ†ä½ â€”â€” è®¡ç®— P99 å»¶è¿Ÿ

**é€‚ç”¨åœºæ™¯**ï¼šTimer/DistributionSummary ç±»å‹ã€‚
è¿™æ˜¯ PromQL ä¸­æœ€å¤æ‚ä½†ä¹Ÿæœ€å¼ºå¤§çš„åŠŸèƒ½ã€‚å®ƒå¯ä»¥æ ¹æ® Bucketï¼ˆæ¡¶ï¼‰æ•°æ®è®¡ç®—å‡ºè¿‘ä¼¼çš„ç™¾åˆ†ä½æ•°ã€‚

```promql
# è®¡ç®— http è¯·æ±‚çš„ P99 å“åº”æ—¶é—´ï¼ˆ99% çš„è¯·æ±‚éƒ½å°äºè¯¥æ—¶é—´ï¼‰
histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket[5m])) by (le))

```

*è§£é‡Šï¼šå…ˆè®¡ç®—æ¯ä¸ª bucket çš„å¢é•¿é€Ÿç‡ï¼Œç„¶åèšåˆï¼Œæœ€ååˆ©ç”¨ `histogram_quantile` å‡½æ•°ä¼°ç®—å‡º P99 çš„å€¼ã€‚è¿™æ˜¯è¯„ä¼°ç³»ç»Ÿ SLA çš„é»„é‡‘æŒ‡æ ‡ã€‚*

# æ€»ç»“ä¸æœ€ä½³å®è·µ

æ­å»ºèµ·ç›‘æ§ç³»ç»Ÿåªæ˜¯ç¬¬ä¸€æ­¥ï¼Œå¦‚ä½•ç»´æŠ¤å¥½è¿™å¥—ç³»ç»Ÿï¼Œä½¿å…¶æ—¢èƒ½åæ˜ çœŸå®é—®é¢˜åˆä¸ä¼šæ‹–å®åŸºç¡€è®¾æ–½ï¼Œåˆ™éœ€è¦éµå¾ªä¸€å®šçš„å·¥ç¨‹åŸåˆ™ã€‚åœ¨æœ¬æ–‡çš„æœ€åï¼Œæˆ‘ä»¬æ€»ç»“äº†åœ¨ä½¿ç”¨ Micrometer å’Œ Prometheus æ—¶å¿…é¡»æ—¶åˆ»å…³æ³¨çš„ä¸‰ä¸ªå…³é”®ç‚¹ã€‚

## 1. æ€§èƒ½éšæ‚£ï¼šè­¦æƒ•â€œåŸºæ•°çˆ†ç‚¸â€ (Cardinality Explosion)

è¿™æ˜¯æ–°æ‰‹æœ€å®¹æ˜“çŠ¯ã€ä¹Ÿæ˜¯åæœæœ€ä¸¥é‡çš„é”™è¯¯ã€‚

åœ¨ Prometheus çš„è®¾è®¡ä¸­ï¼Œæ¯ä¸€ä¸ªç‹¬ç‰¹çš„ **Metric Name + Tags ç»„åˆ** éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ—¶é—´åºåˆ—ï¼ˆTime Seriesï¼‰ã€‚è¿™æ„å‘³ç€ Tags çš„å–å€¼ç©ºé—´ï¼ˆå³â€œåŸºæ•°â€ï¼‰å¿…é¡»æ˜¯**æœ‰é™ä¸”å¯æ§çš„**ã€‚

- **âŒ ç»å¯¹ç¦æ­¢çš„æ“ä½œ**ï¼š
å°†å–å€¼æ— é™æˆ–æé«˜çš„å˜é‡ä½œä¸º Tagã€‚
    - `userId="10086"`
    - `orderId="ORDER_20240101_X"`
    - `email="test@example.com"`
    - `timestamp="1698765432"`

**åæœ**ï¼šå¦‚æœä½ çš„ç³»ç»Ÿæœ‰ 100 ä¸‡ç”¨æˆ·ï¼Œä½¿ç”¨äº† `userId` ä½œä¸º Tagï¼ŒPrometheus å°†ç¬é—´åˆ›å»º 100 ä¸‡ä¸ªæ—¶é—´åºåˆ—ã€‚è¿™ä¼šå¯¼è‡´ Prometheus æœåŠ¡å™¨å†…å­˜è¿…é€Ÿè€—å°½ï¼ˆOOMï¼‰ï¼Œç”šè‡³å¯¼è‡´æ•´ä¸ªç›‘æ§ç³»ç»Ÿå´©æºƒã€‚
- **âœ… æ­£ç¡®çš„æ“ä½œ**ï¼š
ä»…ä½¿ç”¨æœ‰é™æšä¸¾å€¼çš„å˜é‡ä½œä¸º Tagã€‚
    - `method="GET"`
    - `status="500"`
    - `region="cn-north-1"`
    - `error_type="NullPointerException"`

> **é»„é‡‘æ³•åˆ™**ï¼šå¦‚æœä½ ä¸èƒ½æšä¸¾å‡ºä¸€ä¸ª Tag çš„æ‰€æœ‰å¯èƒ½å€¼ï¼ˆæˆ–è€…å¯èƒ½å€¼è¶…è¿‡å‡ ç™¾ä¸ªï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±ä¸é€‚åˆä½œä¸º Tagã€‚å¯¹äºé«˜åŸºæ•°æ•°æ®ï¼ˆå¦‚ OrderIdï¼‰ï¼Œåº”è¯¥å°†å…¶è®°å½•åœ¨ **Logsï¼ˆæ—¥å¿—ï¼‰** æˆ– **Tracingï¼ˆé“¾è·¯è¿½è¸ªï¼‰** ä¸­ï¼Œè€Œä¸æ˜¯ Metrics é‡Œã€‚

## 2. å‘½åè§„èŒƒï¼šå…¥ä¹¡éšä¿—

Java å¼€å‘è€…ä¹ æƒ¯ä½¿ç”¨ `CamelCase`ï¼ˆé©¼å³°å‘½åï¼‰æˆ– `dot.notation`ï¼ˆç‚¹å·åˆ†éš”ï¼‰ï¼Œè€Œ Prometheus ç¤¾åŒºçš„æ ‡å‡†è§„èŒƒæ˜¯ `snake_case`ï¼ˆä¸‹åˆ’çº¿åˆ†éš”ï¼‰ã€‚

**å¥½æ¶ˆæ¯æ˜¯ï¼ŒMicrometer ä¼šè‡ªåŠ¨å¸®ä½ åšè½¬æ¢ã€‚**

- **å»ºè®®**ï¼šåœ¨ Java ä»£ç ä¸­ï¼ŒåšæŒä½¿ç”¨ç‚¹å·åˆ†éš”æ³•ï¼Œè¿™ç¬¦åˆ Java çš„è¯­ä¹‰ä¹ æƒ¯ã€‚
    - ä»£ç ä¸­å†™ï¼š`Counter.builder("business.order.created")`

- **ç»“æœ**ï¼šMicrometer çš„ Prometheus Registry ä¼šè‡ªåŠ¨å°†å…¶æ¸²æŸ“ä¸ºï¼š
    - Prometheus ä¸­è§ï¼š`business_order_created_total`

æ­¤å¤–ï¼ŒPrometheus çš„é€‚é…å™¨é€šå¸¸ä¼šè‡ªåŠ¨ä¸ºæŒ‡æ ‡æ·»åŠ åç¼€ä»¥æ˜ç¡®ç±»å‹ï¼š

- Counter ç±»å‹ä¼šè‡ªåŠ¨åŠ ä¸Š `_total`ã€‚
- Timer/Summary çš„ Sum å€¼ä¼šåŠ ä¸Š `_sum`ï¼ŒCount å€¼ä¼šåŠ ä¸Š `_count`ã€‚
- **æ³¨æ„**ï¼šåœ¨ Grafana ç¼–å†™ PromQL æ—¶ï¼Œè®°å¾—è¦ä½¿ç”¨è½¬æ¢åçš„ä¸‹åˆ’çº¿åç§°ã€‚

## 3. ä¸‹ä¸€æ­¥ï¼šä»â€œçœ‹è§â€åˆ°â€œç®¡ç†â€

æ¼‚äº®çš„å¤§å±èƒ½è®©æˆ‘ä»¬â€œçœ‹è§â€ç³»ç»Ÿçš„çŠ¶æ€ï¼Œä½†è¿™éœ€è¦äººæ—¶åˆ»ç›¯ç€å±å¹•ã€‚çœŸæ­£çš„ç”Ÿäº§çº§ç›‘æ§ï¼Œéœ€è¦å®ç°ä»â€œè¢«åŠ¨æŸ¥çœ‹â€åˆ°â€œä¸»åŠ¨é€šçŸ¥â€çš„é—­ç¯ã€‚

**å»ºè®®çš„åç»­æ­¥éª¤**ï¼š

1. **é…ç½® Alertmanager**ï¼šè¿™æ˜¯ Prometheus ç”Ÿæ€ä¸­çš„å‘Šè­¦å¤„ç†ç»„ä»¶ã€‚
2. **å®šä¹‰å‘Šè­¦è§„åˆ™ (Alert Rules)**ï¼š

    * **åŸºç¡€è®¾æ–½å±‚**ï¼š`InstanceDown` (up == 0)ï¼Œ`HighCpuUsage` (CPU > 80% for 5m)ã€‚
    - **ä¸šåŠ¡å±‚**ï¼š`HighErrorRate` (é”™è¯¯ç‡ > 5%)ï¼Œ`SlowResponse` (P99 > 2s)ã€‚

3. **é›†æˆé€šçŸ¥æ¸ é“**ï¼šå°† Alertmanager å¯¹æ¥è‡³é’‰é’‰ã€é£ä¹¦ã€Slack æˆ– PagerDutyã€‚

é€šè¿‡è¿™ä¸€å¥—ç»„åˆæ‹³ï¼ˆMicrometer åŸ‹ç‚¹ -> Prometheus é‡‡é›† -> Grafana å±•ç¤º -> Alertmanager å‘Šè­¦ï¼‰ï¼Œä½ çš„ Java åº”ç”¨å°†ä¸å†æ˜¯ä¸€ä¸ªé»‘ç›’ï¼Œè€Œæ˜¯ä¸€ä¸ªé€æ˜ã€å¯æ§ã€å¥å£®çš„ç°ä»£åŒ–æœåŠ¡ã€‚

